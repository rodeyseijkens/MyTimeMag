<!doctype html>
<html>

<head>

    <title>My Time Mag.</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="../bower_components/webcomponentsjs/webcomponents.js"></script>

    <link rel="import" href="../bower_components/font-roboto/roboto.html">

    <link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
    <link rel="import" href="../bower_components/core-animated-pages/transitions/slide-from-right.html">
    <link rel="import" href="../bower_components/core-ajax/core-ajax.html">
    <link rel="import" href="../bower_components/core-drawer-panel/core-drawer-panel.html">
    <link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
    <link rel="import" href="../bower_components/core-icon/core-icon.html">
    <link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
    <link rel="import" href="../bower_components/paper-input/paper-input.html">
    <link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="../bower_components/paper-button/paper-button.html">
    <link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">
    <link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">


    <link href="assets/css/main.css" rel="stylesheet" type="text/css">
</head>

<body>
<polymer-element name="my-time-mag">
    <template>
        <link href="assets/css/style.css" rel="stylesheet" type="text/css">
        <core-animated-pages selected="{{options.page}}" notap id="core_pages"
                             transitions="hero-transition cross-fade">
            <section id="section-login" active horizontal layout center center-justified>
                <paper-shadow z="5" id="login-card" class="card" layout vertical cross-fade>
                    <h1>Sign-In</h1>
                    <paper-input-decorator id="loginEmailDecorator" label="Email" floatinglabel layout vertical
                                           error="{{login.error.email}}">
                        <input id="loginEmailInput" is="core-input" type="email"
                               committedValue="{{login.committedValues.email}}" required
                               pattern="^[A-Za-z0-9._%+-]+@([A-Za-z0-9-]+\.)+([A-Za-z0-9]{2,4})$"
                               on-input="{{validateEmail}}" on-change="{{validateEmail}}">
                    </paper-input-decorator>
                    <paper-input-decorator id="loginPasswordDecorator" label="Password" floatinglabel layout
                                           vertical error="{{login.error.password}}">
                        <input id="loginPasswordInput" is="core-input" type="password"
                               committedValue="{{login.committedValues.password}}" required
                               on-input="{{validatePassword}}" on-change="{{validatePassword}}">
                    </paper-input-decorator>
                    <paper-button id="login-button" on-tap="{{checkLogin}}" hero-id="bar" hero>Login</paper-button>
                    <core-ajax id="loginAjax" url="http://mytimemag.rodey.nl/private/user.php?action=login"
                               params='{{login.committedValues}}' handleAs="json"
                               on-core-response="{{loginResponse}}"></core-ajax>
                </paper-shadow>
            </section>
            <section id="section-content" active horizontal layout center center-justified>
                <core-drawer-panel cross-fade>
                    <div drawer>
                        <core-toolbar>
                            <span class="title" flex><core-icon icon="account-circle"></core-icon>{{options.account.email}}</span>
                        </core-toolbar>
                    </div>
                    <div main layout vertical>
                        <core-toolbar hero-id="bar" hero>
                            <paper-icon-button icon="account-circle" core-drawer-toggle></paper-icon-button>
                            <span class="title" show?="{{showingSections}}" flex layout horizontal center-center>
                                <span>My TIME Mag.</span>
                                <paper-icon-button icon="arrow-drop-down"
                                                   on-click="{{toggleSections}}"></paper-icon-button>
                                <paper-icon-button icon="arrow-drop-up"
                                                   on-click="{{toggleSections}}"></paper-icon-button>
                            </span>

                            <div id="searchHolder" show?="{{showingSearch}}">
                                <paper-icon-button icon="search" on-click="{{toggleSearch}}"></paper-icon-button>
                                <input type="search" id="searchInput" on-keyup="{{checkSearch}}" autocomplete="off">
                            </div>
                        </core-toolbar>
                        <paper-tabs selected="{{options.section.page}}" show?="{{showingSections}}" scrollable>
                            <paper-tab>My Time Mag.</paper-tab>
                            <paper-tab>Section 2</paper-tab>
                            <paper-tab>Section 3</paper-tab>
                            <paper-tab>Section 4</paper-tab>
                            <paper-tab>Section 5</paper-tab>
                            <paper-tab>Section 6</paper-tab>
                            <paper-tab>Section 7</paper-tab>
                        </paper-tabs>

                        <core-animated-pages selected="{{options.section.page}}" notap transitions="slide-from-right" flex>

                            <section horizontal layout center center-justified slide-from-right>

                                <paper-shadow z="2" class="main-card" layout vertical>
                                    <h1>PAGE 1</h1>
                                </paper-shadow>

                            </section>

                        </core-animated-pages>
                    </div>
                </core-drawer-panel>
            </section>
        </core-animated-pages>

    </template>
    <script>

        Polymer('my-time-mag', {
            options: [],
            showingSearch: false,
            showingSections: false,

            created: function () {
                this.login = {};
                this.login.error = {};
                this.login.committedValues = {};
                this.options.section = {};
            },

            ready: function () {
                var scope = this;
                this.options.page = 0;
                this.options.section.page = 0;
                this.options.account = [{id: false}];
            },

            nextPage: function (scope) {
                if (!scope) {
                    this.options.page++;
                } else {
                    scope.options.page++;
                }
            },

            checkLogin: function () {
                this.$.loginEmailInput.blur();
                this.$.loginPasswordInput.blur();

                if (!this.$.loginEmailDecorator.isInvalid && !this.$.loginPasswordDecorator.isInvalid) {
                    this.$.loginAjax.go();
                }
            },

            validateEmail: function (event) {
                var decorator = this.$.loginEmailDecorator;
                var input = this.$.loginEmailInput;

                input.setCustomValidity("");

                if (event.target) {
                    if (event.target.committedValue != "") {

                        if (input.validity.valueMissing) {
                            this.login.error.email = "Email is required.";
                        } else if (input.validity.patternMismatch) {
                            this.login.error.email = "This is not a valid email.";
                        }

                        decorator.isInvalid = !input.validity.valid;
                    }
                } else if (event == "invalid") {
                    this.login.error.email = "Email is unknown.";
                    input.setCustomValidity(this.login.error.email);

                    decorator.isInvalid = !input.validity.valid;
                }

                return !decorator.isInvalid;
            },

            validatePassword: function (event) {
                var decorator = this.$.loginPasswordDecorator;
                var input = this.$.loginPasswordInput;

                input.setCustomValidity("");

                if (event == "invalid") {
                    this.login.error.password = "Incorrect password.";
                    input.setCustomValidity(this.login.error.password);
                } else if (input.validity.valueMissing) {
                    this.login.error.password = "Password is required.";
                }
                decorator.isInvalid = !input.validity.valid;

                return !decorator.isInvalid;
            },

            loginResponse: function (event, r) {
                response = r.response;

                if (!response.account.id) {
                    this.validateEmail("invalid");

                    return;
                } else if (!response.account.password) {
                    this.validatePassword("invalid");

                    return;
                } else {
                    this.options.account = response.account;

                    this.nextPage();
                }
            },

            toggleSearch: function (e, detail, sender) {
                if (e) { // comes first
                    e.stopPropagation();
                }
                if (e.target === this.$.input) {
                    return;
                }

                var scope = this;

                setTimeout(function () {

                    scope.showingSearch = !scope.showingSearch;
                    scope.classList.toggle('search-on');
                    scope.async(function () {
                        scope.$.searchInput.focus();
                    });

                }, 0);
            },

            toggleSections: function (e, detail, sender) {
                if (e) { // comes first
                    e.stopPropagation();
                }
                if (e.target === this.$.input) {
                    return;
                }

                var scope = this;

                setTimeout(function () {
                    scope.showingSections = !scope.showingSections;
                    scope.classList.toggle('sections-on');
                }, 0);

            },

            checkSearch: function (e, detail, sender) {
                if (e.keyCode == 13) { // Enter
                    if (sender.value) {

                        //Search
                        console.log(sender.value);

//                        this.toggleSearch(e, detail, sender);
                    }
                }
            }
        });

    </script>
</polymer-element>

<my-time-mag></my-time-mag>

</body>
</html>
<!doctype html>
<html>

<head>

    <title>My Time Mag.</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="../bower_components/webcomponentsjs/webcomponents.js"></script>

    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>

    <link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
    <link rel="import" href="../bower_components/core-animated-pages/transitions/scale-up.html">
    <link rel="import" href="../bower_components/core-ajax/core-ajax.html">
    <link rel="import" href="../bower_components/paper-input/paper-input.html">
    <link rel="import" href="../bower_components/paper-button/paper-button.html">
    <link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">
    <link rel="import" href="../bower_components/core-drawer-panel/core-drawer-panel.html">

    <link href="assets/css/main.css" rel="stylesheet" type="text/css">
</head>

<body fullbleed>
<polymer-element name="my-time-mag">
    <template>
        <link href="assets/css/style.css" rel="stylesheet" type="text/css">
        <core-animated-pages selected="{{options.page}}" notap id="core_pages"
                             transitions="hero-transition cross-fade scale-up">
            <section id="section-login" active horizontal layout center center-justified>
                <paper-shadow z="5" id="login-card" class="card" layout vertical cross-fade>
                    <h1>Sign-In</h1>
                    <paper-input-decorator id="loginEmailDecorator" label="Email" floatinglabel layout vertical
                                           error="{{login.error.email}}">
                        <input id="loginEmailInput" is="core-input" type="email"
                               committedValue="{{login.committedValues.email}}" required
                               pattern="^[A-Za-z0-9._%+-]+@([A-Za-z0-9-]+\.)+([A-Za-z0-9]{2,4}|museum)$">
                    </paper-input-decorator>
                    <paper-input-decorator id="loginPasswordDecorator" label="Password" floatinglabel layout
                                           vertical error="{{login.error.password}}">
                        <input id="loginPasswordInput" is="core-input" type="password"
                               committedValue="{{login.committedValues.password}}" required>
                    </paper-input-decorator>
                    <paper-button id="login-button" on-tap="{{checkLogin}}" hero-id="profile" hero>Login</paper-button>
                    <core-ajax id="loginAjax" url="http://mytimemag.rodey.nl/private/user.php?action=login"
                               params='{{login.committedValues}}' handleAs="json"
                               on-core-response="{{loginResponse}}"></core-ajax>
                </paper-shadow>
            </section>
            <section id="section-content" active horizontal layout center center-justified>
                <core-drawer-panel cross-fade>
                    <div drawer> Drawer panel... </div>
                    <div main> Main panel... </div>
                </core-drawer-panel>
            </section>
        </core-animated-pages>

    </template>
    <script>

        Polymer('my-time-mag', {
            options: [],

            created: function () {
                this.login = {};
                this.login.error = {};
                this.login.committedValues = {};
            },

            ready: function () {
                this.options.page = 0;
                this.options.account = [{id: false}];
            },

            nextPage: function (scope) {
                if (!scope) {
                    this.options.page++;
                } else {
                    scope.options.page++;
                }
            },

            checkLogin: function () {
                if (this.validateEmail() && this.validatePassword()) {
                    this.$.loginAjax.go();
                }
            },

            validateEmail: function (check) {
                var decorator = this.$.loginEmailDecorator;
                var input = this.$.loginEmailInput;

                input.setCustomValidity("");

                if (check == "invalid") {
                    this.login.error.email = "Email is unknown.";
                    input.setCustomValidity(this.login.error.email);
                } else if (input.validity.valueMissing) {
                    this.login.error.email = "Email is required.";
                } else if (input.validity.patternMismatch) {
                    this.login.error.email = "This is not a valid email.";
                }

                decorator.isInvalid = !input.validity.valid;

                return !decorator.isInvalid;
            },

            validatePassword: function (check) {
                var decorator = this.$.loginPasswordDecorator;
                var input = this.$.loginPasswordInput;

                input.setCustomValidity("");

                if (check == "invalid") {
                    this.login.error.password = "Incorrect password.";
                    input.setCustomValidity(this.login.error.password);
                } else if (input.validity.valueMissing) {
                    this.login.error.password = "Password is required.";
                }
                decorator.isInvalid = !input.validity.valid;

                return !decorator.isInvalid;
            },

            loginResponse: function (event, r) {
                response = r.response;

                if (!response.account.id) {
                    this.validateEmail("invalid");

                    return;
                } else if (!response.account.password) {
                    this.validatePassword("invalid");

                    return;
                } else {
                    this.options.account = response.account;

                    this.nextPage();
                }
            }
        });

    </script>
</polymer-element>

<my-time-mag></my-time-mag>

</body>
</html>
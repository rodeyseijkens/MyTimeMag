<!doctype html>
<html>

<head>

    <title>My Time Mag.</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <script src="../bower_components/webcomponentsjs/webcomponents.js"></script>

    <link rel="import" href="../bower_components/font-roboto/roboto.html">

    <link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
    <link rel="import" href="../bower_components/core-animated-pages/transitions/slide-from-right.html">
    <link rel="import" href="../bower_components/core-animated-pages/transitions/slide-up.html">
    <link rel="import" href="../bower_components/core-ajax/core-ajax.html">
    <link rel="import" href="../bower_components/core-drawer-panel/core-drawer-panel.html">
    <link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
    <link rel="import" href="../bower_components/core-icon/core-icon.html">
    <link rel="import" href="../bower_components/core-icons/social-icons.html">
    <link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
    <link rel="import" href="../bower_components/core-localstorage/core-localstorage.html">
    <link rel="import" href="../bower_components/core-image/core-image.html">
    <link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
    <link rel="import" href="../bower_components/paper-input/paper-input.html">
    <link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="../bower_components/paper-button/paper-button.html">
    <link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">
    <link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
    <link rel="import" href="../bower_components/juicy-html/juicy-html.html">
    <link rel="import" href="../bower_components/paper-fab/paper-fab.html">
    <link rel="import" href="../bower_components/paper-toast/paper-toast.html">


    <link href="assets/css/main.css" rel="stylesheet" type="text/css">
</head>

<body>
<polymer-element name="flick-card">
    <template>
        <link href="assets/css/flick-card.css" rel="stylesheet" type="text/css">
        <paper-shadow id="cardShadow" z="1" layout vertical>
            <core-icon icon="thumb-up" class="like overlay"></core-icon>
            <core-icon icon="thumb-down" class="dislike overlay"></core-icon>
            <content></content>
            <paper-ripple id="ripple" class="recenteringTouch" style="pointer-events: none;" fit></paper-ripple>
        </paper-shadow>
    </template>
    <script>
        var xPoint = function (x) {
            this.updated = false;
            this.x = this._prev = this._origin = x;
            this._timeStamp = (new Date()).getTime();
        };
        xPoint.prototype = {
            TIMER_RESET_THRESHOLD: -5/* px */,
            VELOCITY_THRESHOLD: -0.2 /* px/ms */,
            distance: function () {
                // distance between touch start and current point
                return this.x - this._origin;
            },
            update: function (x) {
                // reset time stamp at move stop
                if (x - this.x > this.TIMER_RESET_THRESHOLD) {
                    this._timeStamp = (new Date()).getTime();
                    this._prev = this.x;
                }
                this.x = x;
                this.updated = true;
            }
        };

        var util = {
            applyAnimations: function (n, move) {
                if (move == 0) {
                    var valueTransition = "all 0.3s";
                } else {
                    var valueTransition = "none";
                }

                n.style.webkitTransition = valueTransition;
                n.style.MozTransition = valueTransition;
                n.style.msTransition = valueTransition;
                n.style.OTransition = valueTransition;
                n.style.transition = valueTransition;

                var valueTransform = "translateX(" + move + "px) rotate(" + move / 20 + "deg)";
                n.style.webkitTransform = valueTransform;
                n.style.MozTransform = valueTransform;
                n.style.msTransform = valueTransform;
                n.style.OTransform = valueTransform;
                n.style.transform = valueTransform;

                var likeOverlay = n.shadowRoot.querySelector('.like.overlay');
                var dislikeOverlay = n.shadowRoot.querySelector('.dislike.overlay');

                if (move > 50) {
                    var op = ((move - 50) * 0.5) / 75;
                    likeOverlay.style.opacity = op;
                } else if (move < -50) {
                    var op = ((Math.abs(move) - 50) * 0.5) / 75;
                    dislikeOverlay.style.opacity = op;
                } else {
                    likeOverlay.style.opacity = 0;
                    dislikeOverlay.style.opacity = 0;
                }
            },

            applyLike: function (n, like) {


                if (like) {
                    var move = 300;

                    n.fire('articlelike', {interest: 1});
                } else {
                    var move = -300;

                    n.fire('articlelike', {interest: 0});
                }

                var valueTransition = "all 0.3s";
                n.style.webkitTransition = valueTransition;
                n.style.MozTransition = valueTransition;
                n.style.msTransition = valueTransition;
                n.style.OTransition = valueTransition;
                n.style.transition = valueTransition;

                var valueTransform = "translateX(" + move + "px) rotate(" + move / 20 + "deg)";
                n.style.webkitTransform = valueTransform;
                n.style.MozTransform = valueTransform;
                n.style.msTransform = valueTransform;
                n.style.OTransform = valueTransform;
                n.style.transform = valueTransform;

                n.style.opacity = 0;

                setTimeout(function () {
                    n.remove();
                }, 300);
            }
        };

        Polymer('flick-card', {
            isTapped: false,
            isHold: false,
            ready: function () {
                PolymerGestures.addEventListener(this, "down", this.onDown.bind(this));
                PolymerGestures.addEventListener(this, "track", this.onMove.bind(this));
                PolymerGestures.addEventListener(this, "up", this.onUp.bind(this));
                PolymerGestures.addEventListener(this, "mouseleave", this.onUp.bind(this));
                PolymerGestures.addEventListener(this, "tap", this.onTap.bind(this));
                PolymerGestures.addEventListener(this, "hold", this.onHold.bind(this));
            },
            onHold: function (e) {
                this.classList.add('isHold');
                this.isHold = true;
            },
            onTap: function (e) {
                if(!this.isHold) {
                    //this.classList.add('isHold');
                    this.$.ripple.downAction({x: e.x, y: e.y});

                    var scope = this;

                    setTimeout(function () {
                        scope.$.ripple.upAction();
                    }, 300);
                }
            },
            onDown: function (e) {
                this.point = new xPoint(e.clientX);

                this.classList.add('touching');
            },
            onMove: function (e) {
                this.classList.add('isHold');
                this.isHold = true;
                this.$.ripple.upAction();

                var p = this.point;
                if (p) {
                    p.update(e.clientX);

                    util.applyAnimations(this, p.distance());
                }
            },
            onUp: function (e) {
                var treshold = 150;
                this.$.ripple.upAction();

                this.classList.remove('touching');

                var p = this.point;
                if (!p) {
                    return;
                }

                if (p.distance() <= -treshold) {

                    this.classList.add('disliked');

                    util.applyLike(this, false);

                } else if (p.distance() >= treshold) {

                    this.classList.add('liked');

                    util.applyLike(this, true);

                } else {
                    this.classList.remove('disliked');
                    this.classList.remove('liked');
                    this.async(this.snapBack);
                }

                var scope = this;

                setTimeout(function () {
                    scope.classList.remove('isHold');
                    scope.isHold = false;
                }, 200);

                this.point = null;
            },

            snapBack: function () {
                util.applyAnimations(this, 0);
            }
        });
    </script>
</polymer-element>

<polymer-element name="card-holder" attributes="data amount cardTapFunction articleLikeFunction">
    <template>
        <link href="assets/css/card-holder.css" rel="stylesheet" type="text/css">
        <template repeat="{{article, articleIndex in data.models}}">
            <flick-card data-tags="{{article.tags}}" style="z-index: {{data.models.length - articleIndex}};" data-articleid="{{article.id}}" on-articlelike="{{articleLikeFunction}}" on-tap="{{cardTapFunction}}">
                <h1><template is="juicy-html" content="{{article.short_title | encodeEntities}}"></template></h1>
                <core-image sizing="cover" position="center" src="{{article.img}}" preload placeholder="{{article.imgplaceholder}}" fade></core-image>
            </flick-card>
        </template>
    </template>
    <script>
        Polymer('card-holder', {
            data: [],
            amount: 5,
            created: function () {
            },
            ready: function () {
            }
        });
    </script>
</polymer-element>

<polymer-element name="my-time-mag">
    <template>
        <core-ajax id="contentAjax" url="http://mytimemag.rodey.nl/private/content.php?action=get" params='{{contentAjaxParams}}' handleAs="json"
                   on-core-response="{{contentLoadedResponse}}"></core-ajax>
        <core-ajax id="articleAjax" url="http://mytimemag.rodey.nl/private/content.php?action=get" params='{{articleAjaxParams}}' handleAs="json"
                   on-core-response="{{articleLoadedResponse}}"></core-ajax>
        <core-ajax id="articleInterestedAjax" url="http://mytimemag.rodey.nl/private/interest.php?action=set" params='{{articleInterestParams}}' handleAs="json"
                   on-core-response="{{interestedLoadedResponse}}"></core-ajax>


        <link href="assets/css/style.css" rel="stylesheet" type="text/css">
        <core-animated-pages selected="{{options.page}}" notap id="core_pages"
                             transitions="hero-transition cross-fade slide-up">
            <section id="section-login" horizontal layout center center-justified>
                <paper-shadow z="5" id="login-card" class="card" layout vertical cross-fade>
                    <h1>Sign-In</h1>
                    <paper-input-decorator id="loginEmailDecorator" label="Email" floatinglabel layout vertical error="{{login.error.email}}">
                        <input id="loginEmailInput" is="core-input" type="email" committedValue="{{login.committedValues.email}}" required
                               pattern="^[A-Za-z0-9._%+-]+@([A-Za-z0-9-]+\.)+([A-Za-z0-9]{2,4})$" on-input="{{validateEmail}}" on-change="{{validateEmail}}">
                    </paper-input-decorator>
                    <paper-input-decorator id="loginPasswordDecorator" label="Password" floatinglabel layout vertical error="{{login.error.password}}">
                        <input id="loginPasswordInput" is="core-input" type="password" committedValue="{{login.committedValues.password}}" required on-input="{{validatePassword}}"
                               on-change="{{validatePassword}}">
                    </paper-input-decorator>
                    <paper-button id="login-button" on-tap="{{checkLogin}}" hero-id="bar" hero>Login</paper-button>
                </paper-shadow>
                <core-ajax auto id="loginAjax" url="http://mytimemag.rodey.nl/private/user.php?action=login" params='{{login.committedValues}}' handleAs="json"
                           on-core-response="{{loginResponse}}"></core-ajax>
            </section>
            <section id="section-content" horizontal layout center center-justified>
                <core-drawer-panel disableSwipe>
                    <div drawer>
                        <core-toolbar>
                            <span class="title" flex><core-icon icon="account-circle"></core-icon>{{login.account.email}}</span>
                        </core-toolbar>
                    </div>
                    <div main layout vertical>
                        <core-toolbar hero-id="bar" hero cross-fade>
                            <paper-icon-button icon="account-circle" core-drawer-toggle></paper-icon-button>
                            <span class="title" show?="{{options.sections.show}}" flex layout horizontal center-center>
                                <span>My TIME Mag.</span>
                                <paper-icon-button icon="arrow-drop-down"
                                                   on-click="{{toggleSections}}"></paper-icon-button>
                                <paper-icon-button icon="arrow-drop-up"
                                                   on-click="{{toggleSections}}"></paper-icon-button>
                            </span>

                            <div id="searchHolder" show?="{{options.search.show}}">
                                <paper-icon-button icon="search" on-click="{{toggleSearch}}"></paper-icon-button>
                                <input type="search" id="searchInput" on-keyup="{{checkSearch}}" autocomplete="off">
                            </div>
                        </core-toolbar>
                        <paper-tabs selected="{{options.sections.page}}" show?="{{options.sections.show}}" noink scrollable>
                            <paper-tab>My Time Mag.</paper-tab>
                            <paper-tab>Section 2</paper-tab>
                            <paper-tab>Section 3</paper-tab>
                            <paper-tab>Section 4</paper-tab>
                            <paper-tab>Section 5</paper-tab>
                            <paper-tab>Section 6</paper-tab>
                            <paper-tab>Section 7</paper-tab>
                        </paper-tabs>

                        <core-animated-pages selected="{{options.sections.page}}" notap transitions="slide-from-right" flex>

                            <section id="myTimeMag" horizontal vertical layout center center-justified slide-from-right>

                                <card-holder id="cardHolder" data="{{itemData}}" articleLikeFunction="{{articleSwiped}}" cardTapFunction="{{cardTapped}}" hero-id="articleCard" hero?="{{openedArticle != false}}" cross-fade?="{{openedArticle == false}}"></card-holder>
                            </section>

                            <section id="otherSection" horizontal vertical layout center center-justified slide-from-right>
                                <h1>Other Section Header</h1>
                            </section>

                        </core-animated-pages>
                    </div>
                </core-drawer-panel>
            </section>
            <section id="section-article" layout vertical>
                <core-header-panel id="articleContainer" mode="waterfall-tall" flex data-tags="{{articleData.tags}}" data-articleid="{{articleData.id}}">
                    <core-toolbar style="background-image: url({{articleData.hero.src.small_2x}}); background-size: cover; background-blend-mode: multiply;" hero-id="articleCard" hero?="{{openedArticle != false}}" cross-fade?="{{openedArticle == false}}">
                        <paper-icon-button icon="close" on-tap="{{articleClose}}"></paper-icon-button>
                        <span flex></span>
                        <paper-icon-button id="favoredButton" icon="favorite-outline" on-tap="{{articleFavored}}"></paper-icon-button>
                        <span class="title bottom indent" flex layout horizontal>
                            <span>{{articleData.section.name}}</span>
                        </span>
                    </core-toolbar>

                    <article slide-up>
                        <h1><template is="juicy-html" content="{{articleData.title | encodeEntities}}"></template></h1>
                        <h3><template is="juicy-html" content="{{articleData.excerpt | encodeEntities}}"></template></h3>
                        <template is="juicy-html" content="{{articleData.content | encodeEntities}}"></template>
                    </article>
                </core-header-panel>
                <paper-fab id="like-buttom" icon="social:share" slide-up></paper-fab>

                <paper-toast id="toastAlert" class="capsule" text="{{toastAlertText}}"></paper-toast>
            </section>
        </core-animated-pages>

    </template>
    <script>

        Polymer('my-time-mag', {
            options: {
                page: 0,
                sections: {
                    show: false,
                    name: "",
                    page: 0
                },
                search: {
                    show: false
                }          
            },
            login: {
                account: {id: false, email: false, password: false},
                error: {},
                committedValues: {}
            },
            itemData: {
                index: 0,
                models: []
            },
            articleData: {
            },
            openedArticle: false,
            contentAjaxParams: {},
            articleAjaxParams: {},
            articleInterestParams: {},
            toastAlertText: "",

            created: function () {
                CoreStyle.g.paperInput.labelColor = "#757575";
                CoreStyle.g.paperInput.focusedColor = "#757575";
                CoreStyle.g.paperInput.cursorColor = "#757575";
                CoreStyle.g.paperInput.invalidColor = "#B71C1C";
            },

            ready: function () {
                scope = this;
            },

            nextPage: function () {
                this.options.page++;

                if(this.options.page == 1) {
                    this.options.sections.name = "latest";
                    this.contentAjaxParams = {section: this.options.sections.name, account: this.login.account.id};
                    this.$.contentAjax.go();
                }
            },

            prevPage: function () {
                this.options.page--;
            },

            checkLogin: function () {
                this.$.loginEmailInput.blur();
                this.$.loginPasswordInput.blur();

                if (!this.$.loginEmailDecorator.isInvalid && !this.$.loginPasswordDecorator.isInvalid) {
                    this.$.loginAjax.go();
                }
            },

            validateEmail: function (event) {
                var decorator = this.$.loginEmailDecorator;
                var input = this.$.loginEmailInput;

                input.setCustomValidity("");

                if (event.target) {
                    if (event.target.committedValue != "") {

                        if (input.validity.valueMissing) {
                            this.login.error.email = "Email is required.";
                        } else if (input.validity.patternMismatch) {
                            this.login.error.email = "This is not a valid email.";
                        }

                        decorator.isInvalid = !input.validity.valid;
                    }
                } else if (event == "invalid") {
                    this.login.error.email = "Email is unknown.";
                    input.setCustomValidity(this.login.error.email);

                    decorator.isInvalid = !input.validity.valid;
                }

                return !decorator.isInvalid;
            },

            validatePassword: function (event) {
                var decorator = this.$.loginPasswordDecorator;
                var input = this.$.loginPasswordInput;

                input.setCustomValidity("");

                if (event == "invalid") {
                    this.login.error.password = "Incorrect password.";
                    input.setCustomValidity(this.login.error.password);
                } else if (input.validity.valueMissing) {
                    this.login.error.password = "Password is required.";
                }
                decorator.isInvalid = !input.validity.valid;

                return !decorator.isInvalid;
            },

            contentLoadedResponse: function (event, r) {
                response = r.response;

                this.itemData.models = response.articles;
            },

            articleLoadedResponse: function (event, r) {
                response = r.response;

                this.articleData = response;

                this.nextPage();
            },

            interestedLoadedResponse: function (event, r) {
                response = r.response;

                console.log(response);
            },

            cardTapped: function(e, d, s) {

                if(!s.classList.contains('isHold')) {
                    scope.articleAjaxParams = {page: s.attributes['data-articleid'].value};
                    scope.$.articleAjax.go();

                    s.$.cardShadow.setZ(5);

                    var valueTransform = "scale(1.1)";
                    s.style.webkitTransform = valueTransform;
                    s.style.MozTransform = valueTransform;
                    s.style.msTransform = valueTransform;
                    s.style.OTransform = valueTransform;
                    s.style.transform = valueTransform;

                    scope.openedArticle = s;
                }

            },

            articleFavored: function(e, d, s) {
                if( s.icon != 'favorite') {
                    s.icon = 'favorite';

                    this.toastAlertText = "Added to favorites";

                    this.articleInterest(2, this.$.articleContainer.attributes['data-tags'].value);
                } else {
                    s.icon = 'favorite-outline';

                    this.toastAlertText = "Removed from favorites";
                }
                this.$.toastAlert.show();
            },

            articleClose: function(e, d, s) {
                this.$.articleContainer.scroller.scrollTop = 0;

                this.articleInterest(2, this.$.articleContainer.attributes['data-tags'].value);

//                setTimeout(function(){scope.$.favoredButton.icon = 'favorite-outline'}, 1000);

                this.openedArticle.remove();

                this.openedArticle = false;

                this.prevPage();
            },

            articleSwiped: function(e, d, s) {
                scope.articleInterest(d.interest, s.attributes['data-tags'].value);
            },

            articleInterest: function(interest, tags) {

                console.log(tags);

                switch(interest) {
                    case 3:
                        console.log('FAVORED!!');
                        break;
                    case 2:
                        console.log('READ!!');
                        break;
                    case 1:
                        console.log('LIKED!!');
                        break;
                    default:
                        console.log('DISLIKE!!');
                }
            },

            loginResponse: function (event, r) {
                response = r.response;

                if(response.action == "session") {
                    if (response.account.id && response.account.password) {
                        this.login.account = response.account;

                        this.nextPage();
                    }
                } else if(response.action == "login") {
                    if (!response.account.id) {
                        this.validateEmail("invalid");

                        return;
                    } else if (!response.account.password) {
                        this.validatePassword("invalid");

                        return;
                    } else {
                        this.login.account = response.account;

                        this.nextPage();
                    }
                }
            },

            toggleSearch: function (e, detail, sender) {
                if (e) { // comes first
                    e.stopPropagation();
                }
                if (e.target === this.$.input) {
                    return;
                }

                var scope = this;

                setTimeout(function () {

                    scope.options.search.show = !scope.options.search.show;
                    scope.classList.toggle('search-on');
                    scope.async(function () {
                        scope.$.searchInput.focus();
                    });

                }, 0);
            },

            toggleSections: function (e, detail, sender) {
                if (e) { // comes first
                    e.stopPropagation();
                }
                if (e.target === this.$.input) {
                    return;
                }

                var scope = this;

                setTimeout(function () {
                    scope.options.sections.show = !scope.options.sections.show;
                    scope.classList.toggle('sections-on');
                }, 0);

            },

            checkSearch: function (e, detail, sender) {
                if (e.keyCode == 13) { // Enter
                    if (sender.value) {

                        //Search
                        console.log(sender.value);

//                        this.toggleSearch(e, detail, sender);
                    }
                }
            }
        });

        // Add it as a global expression because it won't detect it elsewise
        PolymerExpressions.prototype.encodeEntities = function(html) {
            var txt = document.createElement("textarea");
            txt.innerHTML = html;
            return txt.value;
        };

    </script>
</polymer-element>

<my-time-mag></my-time-mag>

</body>
</html>